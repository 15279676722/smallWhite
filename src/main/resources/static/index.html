<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>
    <link rel="stylesheet" href="css/event.css" />
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.12.4.min.js"></script>
</head>

<body onload="regChkItem()">
    <div class="container">
        <input class="txtb" type="text" placeholder="Add a task" />
        <div class="notcomp">
            <h3>Not Completed</h3>
        </div>

        <div class="comp">
            <h3>Completed</h3>
        </div>
    </div>

    <script type="text/javascript">
        var websocket = null;
        //判断当前浏览器是否支持WebSocket
        if ('WebSocket' in window) {
            //连接WebSocket节点
            websocket = new WebSocket("ws://localhost:8002/productWebSocket/001");
        }
        else {
            alert('Not support websocket')
        }


        //连接发生错误的回调方法
        websocket.onerror = function () {
            // setMessageInnerHTML("error");
        };


        //连接成功建立的回调方法
        websocket.onopen = function (event) {
            // setMessageInnerHTML("open");
        }


        //接收到消息的回调方法
        websocket.onmessage = function (event) {

            // Drawing(JSON.parse(event.data).data)
            // setMessageInnerHTML(event.data);
        }

        //连接关闭的回调方法
        websocket.onclose = function () {
            // setMessageInnerHTML("close");
            close();
        }
        //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
        window.onbeforeunload = function () {
            websocket.close();
        }


        //将消息显示在网页上
        function setMessageInnerHTML(innerHTML) {
            // document.getElementById('message').innerHTML += innerHTML + '<br/>';
        }


        //关闭连接
        function closeWebSocket() {
            websocket.close();
        }


        //发送消息
        function send() {
            var message = document.getElementById('text').value;
            websocket.send(message);
        }
        function Drawing(data) {
            $(".task").remove();
            data.map(item => {
                if (item.state == 0) {
                    var task = $("<div class='task' id= "+item.id+"></div>").text(item.content);
                    //生成一个确认图标并给确认图标绑定点击事件
                    var check = $("<i class='iconfont iconqueding'></i>").click(function () {
                        let param  = {
                            'id': $('.task').attr('id'),
                        }
                        $.ajax({
                            type: 'POST',
                            url: '/event/update',
                            data: param,
                            dataType: 'json',
                            success: function (data) {
                                let list = data.data.list
                                Drawing(list)
                            },

                        });
                        //找到确认图标的父标签（对应的类为task的div标签）
                        // var p = $(this).parent();
                        //
                        // //将p淡出
                        // p.fadeOut(function () {
                        //     //将div标签加入到comp的div中
                        //     $(".comp").append(p);
                        //
                        //     //将p淡入以达到显示在comp的div中的效果
                        //     p.fadeIn();
                        // });
                        // //将此标签从类为notcomp的div中移除
                        // $(this).remove();
                    });
                    //生成一个删除图标 并给删除图标绑定点击时间
                    var del = $("<i class='iconfont iconshanchu'></i>").click(function () {
                        let param  = {
                            'id': $('.task').attr('id'),
                        }
                        $.ajax({
                            type: 'POST',
                            url: '/event/delete',
                            data: param,
                            dataType: 'json',
                            success: function (data) {
                                let list = data.data.list
                                Drawing(list)
                            },

                        });
                        //找到确认图标的父标签（对应的类为task的div标签）
                        // var p = $(this).parent();
                        //
                        // //淡出
                        // p.fadeOut(function () {
                        //     //将comp中的标签移除
                        //     p.remove();
                        // });

                    })
                    //生成一个带有输入框的值为文本的div标签

                    //将确认和删除图标加入到前面生产的div标签中
                    task.append(check);
                    task.append(del);
                    //将刚刚生成的div标签放置到notcomp的div标签中

                    $(".notcomp").append(task);
                } else {
                    var task = $("<div class='task' id="+item.id+"></div>").text(item.content);
                    //生成一个删除图标 并给删除图标绑定点击时间
                    var del = $("<i class='iconfont iconshanchu'></i>").click(function () {
                        //找到确认图标的父标签（对应的类为task的div标签）
                        // var p = $(this).parent();

                        //淡出
                        // p.fadeOut(function () {
                        //     //将comp中的标签移除
                        //     p.remove();
                        // });
                        let param  = {
                            'id': $('.task').attr('id'),
                        }
                        $.ajax({
                            type: 'POST',
                            url: '/event/delete',
                            data: param,
                            dataType: 'json',
                            success: function (data) {
                                let list = data.data.list
                                Drawing(list)
                            },

                        });

                    })
                    task.append(del);
                    $(".comp").append(task);
                }
            })


            //将输入框的值清空
            // $(".txtb").val("");
        }
        //监控键盘 回车键新增备忘
        $(".txtb").on("keyup", function (e) {
            //监控键盘按下的是否为回车键 及输入框的值是否为空
            if (e.keyCode == 13 && $(".txtb").val() != "") {
                let param  = {
                    'content': $(".txtb").val() ,
                    'state' : 0
                }
                $.ajax({
                    type: 'POST',
                    url: '/event/insert',
                    data: param,
                    dataType: 'json',
                    success: function (data) {
                        let list = data.data.list
                        Drawing(list)
                    },

                });
                //将输入框的值清空
                $(".txtb").val("");
            }
        });
        //界面打开时的方法
        function regChkItem() {
            let param  = {

            }
            $.ajax({
                type: 'POST',
                url: '/event/list',
                data: param,
                dataType: 'json',
                success: function (data) {
                    let list = data.data.list
                    Drawing(list)
                },

            });
        }



    </script>


</body>

</html>